# 更新日志

## [1.3.5] - 2025-08-04

### 🧹 代码优化和精简

#### 代码质量提升
- **精简调试日志**：移除冗余的console.log输出，保留关键错误信息
- **清理未使用变量**：移除未使用的正则表达式和变量声明
- **优化函数逻辑**：简化条件判断和错误处理流程

#### 性能优化
- **减少日志输出**：降低控制台噪音，提升运行效率
- **精简代码体积**：移除不必要的代码，减小脚本大小
- **优化内存使用**：清理未使用的变量和对象

#### 维护性改进
- **代码结构优化**：保持核心功能不变，提升代码可读性
- **错误处理精简**：保留重要错误信息，移除冗余日志
- **注释优化**：保留关键注释，移除过时说明

---

## [1.3.4] - 2025-08-04

### 🚀 实现静默下载功能

#### 主要改进
- **静默下载**：移除浏览器下载确认弹窗，实现自动下载
- **直接保存**：图片直接保存到浏览器默认下载目录
- **无用户干预**：点击按钮后自动完成整个下载流程

#### 技术实现
- **Blob下载方式**：使用 `GM_xmlhttpRequest` + `blob` + 临时下载链接
- **自动触发**：创建隐藏的 `<a>` 元素并自动点击
- **资源清理**：下载完成后自动清理临时DOM元素和blob URL

#### 用户体验优化
- 点击按钮后立即开始下载，无需确认
- 保持原有的Toast提示和进度显示
- 完整的错误处理和状态反馈

---

## [1.3.3] - 2025-08-04

### 🔧 修复文件扩展名检测问题

#### 问题修复
- **修复.htm扩展名问题**：使用HEAD请求预先获取正确的Content-Type
- **智能扩展名检测**：优先从HTTP响应头获取文件类型，备选从URL解析
- **增强请求头**：添加User-Agent和Referer头，提高下载成功率

#### 技术改进
- **两阶段下载流程**：
  1. HEAD请求获取文件信息和正确的Content-Type
  2. 使用正确的文件名进行GM_download下载
- **容错机制**：HEAD请求失败时自动降级到直接下载
- **完整的错误处理**：详细的日志记录和用户提示

#### 权限更新
- 新增 `@connect *` 权限，支持跨域图片下载

---

## [1.3.2] - 2025-08-04

### 🔧 修复图片下载格式问题

#### 问题修复
- **修复图片格式损坏问题**：使用正确的 `GM_download` API 替代自定义blob下载方式
- **改进错误处理**：添加详细的下载错误分类和用户友好提示
- **优化下载流程**：使用Tampermonkey原生下载功能，确保文件完整性

#### 技术改进
- **正确的API使用**：按照Tampermonkey文档正确使用 `GM_download` 函数
- **完整的回调处理**：实现 `onload`、`onerror`、`onprogress` 回调
- **智能错误提示**：根据不同错误类型提供具体的解决建议

#### 错误处理优化
- `not_enabled`: 提示用户在Tampermonkey设置中启用下载功能
- `not_whitelisted`: 提示文件扩展名未被允许
- `not_permitted`: 提示检查浏览器下载权限
- `not_supported`: 提示浏览器不支持下载功能

---

## [1.3.1] - 2025-08-04

### 🔧 修复下载文件扩展名问题

#### 问题修复
- **修复文件扩展名错误**：解决下载图片时文件扩展名变成".htm"的问题
- **改进下载方式**：使用 `GM_xmlhttpRequest` + `blob` 方式替代 `GM_download`
- **智能扩展名检测**：
  - 优先从HTTP响应头的 `Content-Type` 获取正确扩展名
  - 备选从URL路径解析扩展名
  - 默认使用 `.jpg` 扩展名

#### 技术改进
- **更可靠的下载机制**：使用blob URL和临时下载链接
- **更好的错误处理**：分别处理请求错误和响应处理错误
- **资源清理**：自动清理临时blob URL和DOM元素

---

## [1.3.0] - 2025-08-04

### 🖼️ 自动下载封面图片功能

#### 新增功能
- **自动下载封面图片**：
  - 点击色花堂发送按钮时自动下载页面封面图片
  - 图片保存到本地目录：`D:\AVMovies\`
  - 文件名格式：`番号.扩展名`（如：PRED-785.jpg）
  - 支持多种图片格式（jpg、png、webp等）
  - 异步下载，不影响发送到色花堂的主要功能

- **增强的右键菜单**：
  - 新增"下载封面图片"选项，支持单独下载
  - 保留原有的复制、发送、状态查看等功能

- **调试功能增强**：
  - 新增"测试下载图片"调试菜单
  - 详细的下载状态日志记录

#### 技术改进
- **智能图片检测**：
  - 支持多种CSS选择器：`.bigImage img`, `.screencap img`, `img[src*="/pics/cover/"]`
  - 自动处理相对路径和绝对路径
  - 智能扩展名检测和处理

- **错误处理优化**：
  - 详细的错误提示和日志记录
  - 下载失败时的友好提示
  - 异步错误处理，不影响主功能

- **用户体验提升**：
  - 下载开始时显示Toast提示
  - 按钮状态更新，显示下载状态
  - 详细的控制台日志便于调试

#### 权限更新
- 新增 `@grant GM_download` 权限支持文件下载
- 新增 `@grant GM_xmlhttpRequest` 权限支持网络请求

---

## [1.1.0] - 2025-08-03

### 🌸 色花堂番号发送器 - 全新发布

#### 新增功能
- **智能番号检测**：自动识别网页上的各种番号格式
  - 支持普通番号（ABC-123, SSIS-001等）
  - 支持FC2番号（FC2-1234567, FC2PPV-2345678等）
  - 支持无码番号（HEYDOUGA-4017-123, 1pondo-123456_001等）
  - 支持特殊番号（T28-123, CARIB-123456-789等）

- **美观的发送按钮**：
  - 粉色渐变背景设计，符合色花堂主题
  - 流畅的CSS3动画效果
  - 实时状态反馈（发送中→已发送/失败）
  - 光泽扫过效果和弹跳动画

- **跨脚本通信机制**：
  - 基于localStorage的可靠通信
  - 5分钟数据有效期管理
  - 自动过期清理机制
  - 完整的数据验证和错误恢复

- **丰富的用户交互**：
  - 右键菜单：复制番号、查看状态、清理数据
  - Toast提示系统：支持成功/失败/警告/信息四种类型
  - 调试菜单：状态查看、数据管理、功能测试
  - 防重复点击保护

#### 用户体验优化
- **视觉反馈增强**：
  - 按钮hover效果：上移、缩放、阴影变化
  - 发送状态动画：脉冲效果、颜色变化
  - 成功状态动画：弹跳效果、绿色渐变
  - Toast进度条动画

- **错误处理优化**：
  - 智能错误分类和用户友好提示
  - localStorage不可用检测
  - 网络连接问题处理
  - 数据格式验证

- **性能优化**：
  - 防抖机制避免频繁DOM操作
  - 内存泄漏防护
  - 过期数据自动清理
  - 元素重复检测

#### 技术改进
- **代码架构**：
  - 模块化设计，职责分离
  - 完善的错误处理机制
  - 详细的日志记录系统
  - 可扩展的配置管理

- **兼容性**：
  - 支持主流浏览器
  - 与现有脚本完全兼容
  - 动态内容加载支持
  - MutationObserver监听

- **调试支持**：
  - GM_registerMenuCommand调试菜单
  - 详细的控制台日志
  - 存储状态查看功能
  - 通信机制测试工具

#### 接收端脚本更新
- **搜索关键词获取方法优化**：
  - 添加localStorage检查逻辑
  - 时间戳有效性验证
  - 自动数据清理
  - 向后兼容保证

- **错误处理增强**：
  - 损坏数据自动清理
  - 详细的日志记录
  - 异常情况恢复机制

#### 测试和质量保证
- **完整测试体系**：
  - 自动化测试脚本
  - 详细测试报告文档
  - 性能基准测试
  - 兼容性矩阵

- **测试覆盖**：
  - 正常流程测试
  - 边界情况测试
  - 异常场景测试
  - 兼容性测试

### 文档更新
- 更新README.md，添加发送器功能说明
- 创建详细的测试报告文档
- 添加使用说明和故障排除指南
- 创建更新日志文件

### 已知问题
- Safari浏览器可能需要用户手动授权localStorage访问
- 某些网站的CSP策略可能影响脚本运行
- 极少数情况下可能出现按钮重复显示

### 下一版本计划
- 添加更多番号格式支持
- 优化大页面的检测性能
- 添加批量发送功能
- 支持自定义按钮样式
- 添加统计和分析功能

---

## [2.2.0] - 2024-XX-XX

### SeHuaTang Forum Searcher Pro 更新

#### 智能冷却期管理
- 解决了"刚打开搜索主页就提示跳过执行"的问题
- 智能页面检测：区分首页、搜索页面和其他页面
- 差异化冷却期：首页/搜索页面1-10秒，其他页面2-30秒
- 首次访问优化：首次访问或长时间未执行时直接允许执行
- 页面刷新检测：自动清理过期状态，避免误判
- 友好提示信息：显示剩余冷却时间和详细状态

#### 增强的调试功能
- 状态查看：`SeHuaTangConfig.getStatus()` - 查看详细运行状态
- 状态清理：`SeHuaTangConfig.clearState()` - 手动清除状态
- 智能重置：自动检测异常状态并重置

#### 用户体验优化
- 禁用剪贴板复制：不再自动复制磁力链接到剪贴板
- 简化页面关闭：搜索页面在点击链接时立即关闭
- Apple风格弹窗：保存失败时显示美观的错误提示弹窗
- 智能页面管理：使用更简单可靠的页面关闭逻辑

#### 静默API提交
- 静默处理：不显示任何弹窗提示或用户通知
- 标题清理：自动移除标题中的各种标记
- 数据提交：向后端API发送HTTP请求
- 错误处理：包含重试机制和超时处理
- 数据验证：确保所有必要字段都不为空且格式正确

---

## 版本说明

### 版本号规则
- 主版本号：重大功能更新或架构变更
- 次版本号：新功能添加或重要改进
- 修订版本号：Bug修复或小幅优化

### 支持和反馈
如有问题或建议，请通过以下方式联系：
- GitHub Issues
- 用户脚本评论区
- 邮件反馈

### 许可证
本项目采用MIT许可证，详见LICENSE文件。
